# gdd_combat_system.md - 戦闘システム

## 概要

このドキュメントは、「CardsAndDices」プロジェクトにおける戦闘システムの核心的なコンセプトを詳述します。

---

## コンセプト

「CardsAndDices」は、カードとダイスを組み合わせた戦略性の高い戦闘システムを目指します。
ボードゲームのようなプレイヤーの選択を求められるシステムで、コマンドバトルのようなじっくり考えて戦うシステムです

---

## 戦闘に関わるゲームオブジェクト

- **クリーチャーカード**
    - 能力値や固有能力を持ったカード。相手のクリーチャーカードと戦う
    - キャラクターやモンスターとしての側面も持ち、固有の画像で表現される
    - 固有能力にはダイスインレットとして実装されるものと、特定の条件で発動するもの（ダメージを受けた時に反撃する、特定の場所に配置すると能力値が上昇するなど）
    - ダイスインレットと条件発動の能力がクリーチャーカードの個性を意味する
- **カードスロット**
    - クリーチャーカードの置き場
    - 普段は見えないが、カードをドラックするとおける場所として強調表示される
- **ダイスインレット**
    - クリーチャーカードに最大２つ付いている固有能力。ダイスをコストとして入れることで能力が発動する
    - 味方クリーチャーカードについているインレットは、攻撃やバフデバフを発動する
    - 敵クリーチャーカードについているインレットは、発動することで敵の固有能力を封じる
- **ダイス**
    - プレイヤーが持つダイスの数だけ配置され、配置時に１～６のランダムな値になる（６面ダイス）
    - 敵味方のクリーチャーカードにあるダイスインレットの発動のコストになる
    - ターンごとにリセットされる
- **ダイススロット**
    - ダイスの置き場
    - ダイスをドロップすることはできない。ダイスドロップが失敗した場合の戻る場所とターン開始時のリロール場所などに使用する

---

## 戦闘システム概要

### 1. 戦闘フロー

#### 1.1 戦闘開始フェーズ

- プレイヤーは、手札のクリーチャーカードを戦闘画面に配置する
- 敵のクリーチャーカードは、この時点で配置されている
- プレイヤーが１枚以上のクリーチャーカードを配置した状態で、戦闘開始ボタンを押下するとプレイヤーインプットフェーズに移行する

#### 1.2 プレイヤーインプットフェーズ

- プレイヤーが操作できるフェーズ。プレイヤーは以下の動作が行える
- **ダイスを使う**
    - クリーチャーカードのダイスインレットに、ドラッグアンドドロップすると、ダイスエフェクトフェーズに移行する
- **クリーチャーカードの配置換え**
    - 戦闘画面に配置されているクリーチャーカードの配置場所を変更する
    - これにより、ダメージを与える相手カードや、受ける味方カードを変更し、戦闘を優位に進めることができる
- **ネクストターンボタン**
    - ネクストターンボタンを押下するとターン更新フェースに移行する

#### 1.3 ダイスエフェクトフェーズ

- ダイスインレットにダイスが投入されると以下の処理が行われる
1. ダイスインレット発動チェック
2. ダイスインレット効果発動
3. クールダウン処理
4. クールダウン基礎攻撃処理
5. 勝敗判定
6. プレイヤーインプットフェーズに移行

#### 1.4 ターン更新フェーズ

- ネクストターンボタンを押下すると以下の処理が行われる
1. ターン更新時に発動する固有能力の発動
    - 敵のクリーチャーカードは、ほぼ全てこの能力を持ち、敵クリーチャーのインレットは、この能力を１回封じる
2. 勝敗判定
3. ダイスの再ロール
4. ウェーブ処理
5. プレイヤーインプットフェーズに移行

### 2. ウェーブ

一定ターン経過または敵全滅で次ウェーブへ移行

### 3. スロット配置場所

| PlayerZone                         | EnemyZone                          |
| ----------------------------------- | ----------------------------------- |
| TopLine                            | TopLine                             |
| RearSlot CenterSlot VanguardSlot   | VanguardSlot CenterSlot RearSlot    |
| BottomLine                         | BottomLine                          |
| RearSlot CenterSlot VanguardSlot   | VanguardSlot CenterSlot RearSlot    |

| HandZone                           |
| ----------------------------------- |
| HandSlot ×8                         |

| DiceZone                           |
| ----------------------------------- |
| DiceSlot ×8                         |

#### 3.1 隣接判定マトリックス

  |               | TopLine.Rear | TopLine.Center | TopLine.Vanguard | BottomLine.Rear | BottomLine.Center | BottomLine.Vanguard |
  | ------------- | ------------ | -------------- | ---------------- | --------------- | ----------------- | ------------------- |
  | TopLine.Rear  | –            | ○             |                  | ○               |                   |                     |
  | TopLine.Center| ○            | –              | ○               |                 | ○                 |                     |
  | TopLine.Vanguard|           | ○             | –                |                 |                   | ○                   |
  | BottomLine.Rear| ○          |                |                  | –               | ○                 |                     |
  | BottomLine.Center|          | ○              |                  | ○               | –                 | ○                  |
  | BottomLine.Vanguard|        |                | ○                |                 | ○                 | –                   |

### 4. 攻撃処理のルール

- 同ラインのVanguardを優先し、次に他ラインのVanguard  
- 複数敵への攻撃はカードやインレット効果で発生  

### 5. 手札からのカード配置ルール

- プレイヤーは、HandZoneにあるクリーチャーカードをPlayerZoneの空きスロットにドラッグ＆ドロップすることで配置できる。
- PlayerZoneのスロット（計6つ）が全て埋まっている場合、**「満員」**状態となる。
- 「満員」状態では、HandZoneにある全てのクリーチャーカードは配置できなくなり、プレイヤーにその状態が視覚的に（例：グレーアウト表示）で伝えられる。

### 6. クリーチャーカードの基本データ

#### 6.1 識別子
- creatureId：クリーチャーカードを一意に識別する文字列
    - クリーチャー名や見た目の画像などにアクセスするためのID。特にクリーチャー名などは、後からの変更や多言語に対応するため、別のScriptableObjectとして管理する

#### 6.2 能力値（ability scores）

- attack：攻撃力
- health：体力
- shield：シールド値
- cooldown：クールダウンダイス数
- energy：特殊な能力値

#### 6.3 アビリティ（Abilities）

- abilities：固有能力データのリスト

#### 6.4 インレット情報（InletAbilityProfiles）

- ２つのインレットの `「発動条件」と「効果」をセットで保持する不変なデータ`

### 7. バフ／デバフ管理方針

- クリーチャーカードデータには攻撃力・体力・エネルギー等の基本ステータスのみを保持し、バフ／デバフ効果はエフェクトマネージャーで一元管理する
- エフェクトデータで以下を定義
  - 効果内容（ステータス増減量、適用対象など）
  - 寿命条件（残存ターン数、ターン終了、クールダウンリセットイベント など）
- エフェクトインスタンスが保持する情報
  - 対象 カードID
  - 参照する エフェクトデータ
  - 残存ターン数や終了トリガー情報
- マネージャークラスは次のイベントを購読し、カードIDをキーに寿命管理を行う
  - ターン終了イベント／ターンエンドイベント
  - クールダウンリセットイベント（ペイロードに対象カードIDを含む）
- クールダウンリセットイベントはコマンド内で
  1. カウント減少処理実行
  2. カウントが0になったタイミングでペイロードにカードIDを含めて発行
- イベント受信時、エフェクトマネージャーは対象カードIDとエフェクトインスタンスのカードIDを照合し寿命条件を満たした場合にエフェクト有効期限コマンドをコマンド実行マネージャ経由で実行
- バフデバフの適用コマンドとエフェクト有効期限コマンドは共通インタフェースに準拠し、パラメータ保持を一貫して処理
- UI・演出はバフデバフ適用イベントでリアクティブに更新する
- 詳細な実装仕様は [sys_effect_management.md](../sys/sys_effect_management.md) にまとめる

### 8. 効果範囲
  - 攻撃やバフデバフの効果範囲。単体、一列、全体、前衛の４種類がある
  - 単体はクリーチャーカード１枚を対象にでき、Vanguard->Center->Rearの順に優先され、次に自分と同じLineに配置されたクリーチャーカードが優先される
  - 一列は、自分と同じLineに配置された（敵か味方のクリーチャーカード全部）
  - 前衛は、Vanguardに配置された敵か味方のクリーチャーカード（つまり最大２枚）
  - 全体は、敵か味方のクリーチャーカードすべて。
  - インレットや固有能力で発動する攻撃は、その固有能力が効果範囲を持つ（例：敵の一列）
  - クールダウン基礎攻の範囲は、バフデバフで変更できる

### 9. クールダウン基礎攻撃
  - `cooldown` が0になったクリーチャーカードは、攻撃処理のルールに則り、相手のクリーチャーカードを攻撃する
  - 攻撃の効果範囲は、基本的に単体であるが、アビリティの効果などで変更できる
  - 同タイミングで`cooldown` が0になった場合、敵のクリーチャーカードから先に攻撃する
  - 同じ陣営での順序は配置場所に依存し、Vanguard->Center->Rearの順に行われる

---

## 関連ファイル

- [gdd_main.md](./gdd_main.md)
- [gdd_game_object_specs.md](./gdd_game_object_specs.md)
- [sys_card-reflow.md](../sys/sys_card-reflow.md)
- [ui_creature_card_interaction.md](../ui/ui_creature_card_interaction.md)
- [ui_card_slot_interaction.md](../ui/ui_card_slot_interaction.md)

---

## 更新履歴

- 2025-08-15: バフ／デバフ管理方針、効果範囲、クールダウン基礎攻撃セッション追加 (Nekodamasi)
- 2025-08-14: クリーチャーカードの基本データセッション追加 (Nekodamasi)
- 2025-07-30: 関連ファイルセッション追加 (Nekodamasi)
- 2025-07-23: 初版 (Nekodamasi)
